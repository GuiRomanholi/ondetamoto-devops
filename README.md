# Projeto Ondetamoto - Guia de Deploy e Execu√ß√£o na Azure

Este documento detalha o processo completo para provisionar a infraestrutura na Microsoft Azure, realizar o deploy da aplica√ß√£o Java (Spring Boot) via GitHub Actions e verificar a sua funcionalidade.

## üìù Descri√ß√£o da Solu√ß√£o

O projeto **OndeT√°Moto?** √© uma solu√ß√£o tecnol√≥gica baseada em IoT (Internet das Coisas) desenvolvida para a Mottu, uma empresa de motofrete, com o objetivo de gerenciar e controlar motos em tempo real dentro de sua garagem. O sistema utiliza tags inteligentes em cada moto para registrar automaticamente seus movimentos (entrada, sa√≠da e perman√™ncia). Esses dados s√£o centralizados em um aplicativo mobile com uma interface amig√°vel, permitindo √† equipe visualizar o status, localiza√ß√£o, e categoriza√ß√£o de cada moto.

## üìà Descri√ß√£o dos Benef√≠cios para o Neg√≥cio

A solu√ß√£o **OndeT√°Moto?** resolve o problema de controle ineficiente das motos na garagem da Mottu, substituindo planilhas e anota√ß√µes manuais. Ela traz os seguintes benef√≠cios para o neg√≥cio:

* **Visibilidade e Agilidade**: Oferece informa√ß√µes em tempo real sobre a localiza√ß√£o e status das motos, aumentando a visibilidade operacional.
* **Efici√™ncia e Precis√£o**: Automatiza o registro de movimenta√ß√µes, reduzindo erros humanos e retrabalhos.
* **Organiza√ß√£o e Seguran√ßa**: Promove um controle mais organizado e seguro da frota.
* **Inova√ß√£o Adaptada**: Utiliza tecnologia IoT para uma gest√£o pr√°tica e inteligente, sob medida para a opera√ß√£o da Mottu.

## üéØ Sum√°rio

* [Pr√©-requisitos](#-pr√©-requisitos)
* [Parte 1: Provisionamento da Infraestrutura do Banco de Dados](#-parte-1-provisionamento-da-infraestrutura-do-banco-de-dados)
* [Parte 2: Deploy da Aplica√ß√£o com Script Automatizado](#-parte-2-deploy-da-aplica√ß√£o-com-script-automatizado)
* [Parte 3: Configura√ß√£o do Deploy Cont√≠nuo com GitHub Actions](#-parte-3-configura√ß√£o-do-deploy-cont√≠nuo-com-github-actions)
    * [3.1 Configurando os Segredos (Secrets) do Reposit√≥rio](#31-configurando-os-segredos-secrets-do-reposit√≥rio)
    * [3.2 Ajustando o Arquivo de Workflow (.yml)](#32-ajustando-o-arquivo-de-workflow-yml)
    * [3.3 Obtendo e Configurando o Perfil de Publica√ß√£o (Publish Profile)](#33-obtendo-e-configurando-o-perfil-de-publica√ß√£o-publish-profile)
* [Parte 4: Verifica√ß√£o e Testes](#-parte-4-verifica√ß√£o-e-testes)
    * [4.1 Verificando as Tabelas no Banco de Dados](#41-verificando-as-tabelas-no-banco-de-dados)
    * [4.2 Testando a API com Requisi√ß√µes](#42-testando-a-api-com-requisi√ß√µes)
* [Considera√ß√µes Finais e Troubleshooting](#-considera√ß√µes-finais-e-troubleshooting)

## ‚úîÔ∏è Pr√©-requisitos

Antes de come√ßar, garanta que voc√™ tenha:

1.  **Conta na Microsoft Azure**: Com uma assinatura ativa.
2.  **Azure CLI**: Instalado e configurado em sua m√°quina ou utilize o **Cloud Shell** diretamente no portal Azure.
3.  **Reposit√≥rio no GitHub**: Com o c√≥digo-fonte da aplica√ß√£o.

## üé• Link do V√≠deo
[Link do Video de Devops](https://www.youtube.com/watch?v=MEZ-fd3zk-c)

---

## üöÄ Parte 1: Provisionamento da Infraestrutura do Banco de Dados

O primeiro passo √© criar os recursos do banco de dados (Grupo de Recursos, Servidor SQL e o pr√≥prio Banco de Dados) usando um script no Azure Cloud Shell.

1.  Acesse o [Portal Azure](https://portal.azure.com/) e abra o **Cloud Shell** (√≠cone `>_` no topo). Certifique-se de que o ambiente selecionado seja o **Bash**.

2.  Crie o script de cria√ß√£o da infraestrutura:
    ```bash
    touch create-sql-server.sh
    ```

3.  D√™ permiss√£o de execu√ß√£o para o script:
    ```bash
    chmod +x create-sql-server.sh
    ```

4.  Abra o editor `nano` para colar o conte√∫do do script:
    ```bash
    nano create-sql-server.sh
    ```

5.  Cole o seguinte c√≥digo no editor. **Aten√ß√£o:** √â uma boa pr√°tica de seguran√ßa n√£o expor senhas diretamente no c√≥digo. Para ambientes de produ√ß√£o, utilize o Azure Key Vault ou outras formas seguras de gerenciamento de segredos.

    ```bash
    #!/bin/bash
    
    # Vari√°veis de configura√ß√£o
    RG="rg-ondetamoto"
    LOCATION="brazilsouth"
    SERVER_NAME="sqlserver-rm557462"
    USERNAME="admsql"
    # Lembre-se da boa pr√°tica de n√£o deixar senhas no c√≥digo em ambientes de produ√ß√£o.
    PASSWORD="Fiap@2tdsvms"
    DBNAME="ondetamotodb"
    
    # Cria o grupo de recursos
    echo "Criando o grupo de recursos: $RG..."
    az group create --name $RG --location $LOCATION
    
    # Cria o servidor SQL
    echo "Criando o servidor SQL: $SERVER_NAME..."
    az sql server create -l $LOCATION -g $RG -n $SERVER_NAME -u $USERNAME -p $PASSWORD --enable-public-network true
    
    # Cria o banco de dados (que estar√° vazio, pronto para o Flyway)
    echo "Criando o banco de dados: $DBNAME..."
    az sql db create -g $RG -s $SERVER_NAME -n $DBNAME --service-objective Basic --backup-storage-redundancy Local --zone-redundant false
    
    # Cria a regra de firewall para permitir acesso de servi√ßos do Azure e outros IPs
    echo "Configurando a regra de firewall..."
    az sql server firewall-rule create -g $RG -s $SERVER_NAME -n AllowAll --start-ip-address 0.0.0.0 --end-ip-address 255.255.255.255
    
    echo "Infraestrutura do banco de dados criada com sucesso!"
    echo "O banco '$DBNAME' est√° pronto e vazio para o Flyway gerenciar o schema."
    ```
    Salve e feche o editor (`CTRL + S`, depois `CTRL + X` e `Enter`).

6.  Execute o script para criar os recursos:
    ```bash
    ./create-sql-server.sh
    ```

---

## ‚öôÔ∏è Parte 2: Deploy da Aplica√ß√£o com Script Automatizado

Este script ir√° criar o App Service, o Application Insights e configurar as vari√°veis de ambiente necess√°rias para a aplica√ß√£o se conectar ao banco de dados.

1.  Ainda no Cloud Shell, crie o script de deploy:
    ```bash
    touch deploy-ondetamoto.sh
    ```

2.  D√™ permiss√£o de execu√ß√£o:
    ```bash
    chmod +x deploy-ondetamoto.sh
    ```

3.  Abra o editor `nano`:
    ```bash
    nano deploy-ondetamoto.sh
    ```

4.  Cole o script abaixo, **lembrando de alterar** o valor da vari√°vel `GITHUB_REPO_NAME` para o seu usu√°rio e reposit√≥rio.

    ```bash
    #!/bin/bash
    
    # --- Vari√°veis de Configura√ß√£o da Aplica√ß√£o ---
    # Altere 'rm557462' e seu reposit√≥rio GitHub
    export RESOURCE_GROUP_NAME="rg-ondetamoto"
    export WEBAPP_NAME="ondetamoto-rm557462"
    export APP_SERVICE_PLAN="planOndetamoto"
    export LOCATION="brazilsouth"
    export RUNTIME="JAVA:17-java17"
    export GITHUB_REPO_NAME="GuiRomanholi/ondetamoto-devops"
    export BRANCH="main"
    export APP_INSIGHTS_NAME="ai-ondetamoto"
    
    # --- Vari√°veis do Banco de Dados ---
    export DB_SERVER_NAME="sqlserver-rm557462"
    export DB_NAME="ondetamotodb"
    export DB_USER="admsql"
    export DB_PASSWORD="Fiap@2tdsvms" # ATEN√á√ÉO: Altere esta senha para uma segura!
    
    # Constru√ß√£o da URL JDBC dinamicamente
    export JDBC_URL="jdbc:sqlserver://${DB_SERVER_NAME}.database.windows.net:1433;database=${DB_NAME};encrypt=true;trustServerCertificate=false;hostNameInCertificate=*.database.windows.net;loginTimeout=30;"
    
    echo "Iniciando o deploy da aplica√ß√£o e infraestrutura..."
    
    # Criar Application Insights
    az monitor app-insights component create \
    --app "$APP_INSIGHTS_NAME" \
    --location "$LOCATION" \
    --resource-group "$RESOURCE_GROUP_NAME" \
    --application-type web
    
    # Criar o Plano de Servi√ßo
    az appservice plan create \
    --name "$APP_SERVICE_PLAN" \
    --resource-group "$RESOURCE_GROUP_NAME" \
    --location "$LOCATION" \
    --sku F1 \
    --is-linux
    
    # Criar o Servi√ßo de Aplicativo (Web App)
    az webapp create \
    --name "$WEBAPP_NAME" \
    --resource-group "$RESOURCE_GROUP_NAME" \
    --plan "$APP_SERVICE_PLAN" \
    --runtime "$RUNTIME"
    
    # Habilita a autentica√ß√£o B√°sica (SCM) para deploy
    az resource update \
    --resource-group "$RESOURCE_GROUP_NAME" \
    --namespace Microsoft.Web \
    --resource-type basicPublishingCredentialsPolicies \
    --name scm \
    --parent sites/"$WEBAPP_NAME" \
    --set properties.allow=true
    
    # Recuperar a String de Conex√£o do Application Insights
    CONNECTION_STRING=$(az monitor app-insights component show \
    --app "$APP_INSIGHTS_NAME" \
    --resource-group "$RESOURCE_GROUP_NAME" \
    --query connectionString \
    --output tsv)
    
    # Configurar as Vari√°veis de Ambiente da Aplica√ß√£o
    az webapp config appsettings set \
    --name "$WEBAPP_NAME" \
    --resource-group "$RESOURCE_GROUP_NAME" \
    --settings \
    APPLICATIONINSIGHTS_CONNECTION_STRING="$CONNECTION_STRING" \
    ApplicationInsightsAgent_EXTENSION_VERSION="~3" \
    XDT_MicrosoftApplicationInsights_Mode="Recommended" \
    XDT_MicrosoftApplicationInsights_PreemptSdk="1" \
    SPRING_DATASOURCE_USERNAME="$DB_USER" \
    SPRING_DATASOURCE_PASSWORD="$DB_PASSWORD" \
    SPRING_DATASOURCE_URL="$JDBC_URL"
    
    # Reiniciar o Web App para aplicar as configura√ß√µes
    az webapp restart \
    --name "$WEBAPP_NAME" \
    --resource-group "$RESOURCE_GROUP_NAME"
    
    # Conectar Web App ao Application Insights
    az monitor app-insights component connect-webapp \
    --app "$APP_INSIGHTS_NAME" \
    --web-app "$WEBAPP_NAME" \
    --resource-group "$RESOURCE_GROUP_NAME"
    
    # Configurar GitHub Actions para Build e Deploy autom√°tico
    az webapp deployment github-actions add \
    --name "$WEBAPP_NAME" \
    --resource-group "$RESOURCE_GROUP_NAME" \
    --repo "$GITHUB_REPO_NAME" \
    --branch "$BRANCH" \
    --login-with-github
    
    echo "Deploy conclu√≠do com sucesso!"
    ```
    Salve e feche o editor.

5.  Execute o script:
    ```bash
    ./deploy-ondetamoto.sh
    ```
    Este comando ir√° configurar o GitHub Actions, mas o arquivo de workflow gerado pode precisar de ajustes.

---

## üîß Parte 3: Configura√ß√£o do Deploy Cont√≠nuo com GitHub Actions

O script anterior cria a base, mas agora precisamos garantir que o GitHub consiga autenticar na Azure e que o processo de build e deploy da aplica√ß√£o Java funcione corretamente.

### 3.1 Configurando os Segredos (Secrets) do Reposit√≥rio

As credenciais do banco de dados n√£o devem ficar no c√≥digo. Vamos configur√°-las como "Secrets" no GitHub.

1.  No seu reposit√≥rio GitHub, v√° em **Settings** > **Secrets and variables** > **Actions**.
2.  Clique em **New repository secret** e adicione os seguintes segredos:

    * **Nome**: `SPRING_DATASOURCE_USERNAME`
        * **Valor**: `admsql`

    * **Nome**: `SPRING_DATASOURCE_PASSWORD`
        * **Valor**: `Fiap@2tdsvms`

    * **Nome**: `SPRING_DATASOURCE_URL`
        * **Como obter o valor**: V√° para o Portal Azure > `rg-ondetamoto` > `ondetamotodb (sqlserver-rm557462/ondetamotodb)` > `Configura√ß√µes` > `Cadeias de conex√£o` > copie o valor do campo **JDBC**.
        > jdbc:sqlserver://sqlserver-rm557462.database.windows.net:1433;database=ondetamotodb;user=admsql@sqlserver-rm557462;password={your_password_here};encrypt=true;trustServerCertificate=false;hostNameInCertificate=*.database.windows.net;loginTimeout=30;

### 3.2 Ajustando o Arquivo de Workflow (.yml)

O script `deploy-ondetamoto.sh` cria um arquivo de workflow `.yml` no seu reposit√≥rio, dentro da pasta `.github/workflows/`. Este arquivo provavelmente precisar√° ser substitu√≠do.

1.  No seu reposit√≥rio, localize e abra o arquivo `.yml` rec√©m-criado.
2.  Substitua **todo o conte√∫do** dele pelo c√≥digo abaixo. Este c√≥digo est√° ajustado para um build com Gradle e Java 17.

    ```yaml
    # Docs for the Azure Web Apps Deploy action: [https://github.com/Azure/webapps-deploy](https://github.com/Azure/webapps-deploy)
    # More GitHub Actions for Azure: [https://github.com/Azure/actions](https://github.com/Azure/actions)
    
    name: 'Build and deploy JAR app to Azure Web App: ondetamoto-rm557462'
    
    on:
      push:
        branches:
          - main
      workflow_dispatch:
    
    jobs:
      build-and-deploy:
        runs-on: ubuntu-latest
        steps:
        - uses: actions/checkout@v2
        
        - name: Set up Java version
          uses: actions/setup-java@v1
          with:
            java-version: '17'
            
        - name: Grant execute permission to gradlew
          run: chmod +x ./gradlew
          
        - name: Build with Gradle
          env:
            SPRING_DATASOURCE_URL: ${{ secrets.SPRING_DATASOURCE_URL }}
            SPRING_DATASOURCE_USERNAME: ${{ secrets.SPRING_DATASOURCE_USERNAME }}
            SPRING_DATASOURCE_PASSWORD: ${{ secrets.SPRING_DATASOURCE_PASSWORD }}
          run: ./gradlew build --stacktrace
          
        - name: Deploy to Azure Web App
          uses: azure/webapps-deploy@v2
          with: 
            app-name: 'ondetamoto-rm557462'
            slot-name: 'production'
            publish-profile: ${{ secrets.AZUREAPPSERVICE_PUBLISHPROFILE_5B0BB8510E2D4B95800D1A7EA53D1044 }} # LEMBRE-SE DE VERIFICAR O NOME DO SECRET!
            package: 'build/libs/*.jar'
    ```

### 3.3 Obtendo e Configurando o Perfil de Publica√ß√£o (Publish Profile)

O workflow precisa de um segredo especial (`AZUREAPPSERVICE_PUBLISHPROFILE_...`) para se autenticar na Azure. O script de deploy j√° deve ter criado este segredo, mas caso precise ser atualizado ou criado manualmente:

1.  No Portal Azure, navegue at√© o seu App Service (`ondetamoto-rm557462` dentro do grupo `rg-ondetamoto`).
2.  Clique em **Baixar o perfil de publica√ß√£o**. Um arquivo `.PublishSettings` ser√° baixado.
3.  Abra este arquivo com um editor de texto (como o VS Code).
4.  Copie **todo o conte√∫do** do arquivo.
5.  Volte para os segredos do seu reposit√≥rio no GitHub (**Settings** > **Secrets and variables** > **Actions**).
6.  Encontre o segredo chamado `AZUREAPPSERVICE_PUBLISHPROFILE_...` e clique em **Update**. Cole o conte√∫do que voc√™ copiou no campo de valor. Se ele n√£o existir, crie-o com este nome.

Ap√≥s salvar o novo arquivo `.yml` e confirmar os segredos, um `push` para a branch `main` ir√° disparar a Action, que far√° o build do projeto e o deploy na Azure.

---

## üî¨ Parte 4: Verifica√ß√£o e Testes

### 4.1 Verificando as Tabelas no Banco de Dados

Ap√≥s a conclus√£o do deploy pelo GitHub Actions, o Flyway dever√° ter executado as migrations e criado as tabelas.

1.  No Portal Azure, v√° para o seu banco de dados `ondetamotodb`.
2.  No menu lateral, selecione **Editor de Consultas (visualiza√ß√£o)**.
3.  Fa√ßa o login com a **Autentica√ß√£o do SQL Server**:
    * **Login**: `admsql`
    * **Senha**: `Fiap@2tdsvms`
4.  Execute as seguintes consultas para verificar se as tabelas foram criadas e se cont√™m dados:

    ```sql
    select * from estabelecimento;
    select * from setores;
    select * from moto;
    select * from usuario;
    ```

### 4.2 Testando a API com Requisi√ß√µes

## üîó Rotas Pricipais pra Teste (Swagger)

A API do projeto podia ser acessada via Swagger na rota:

[http://ondetamoto-rm557462.azurewebsites.net/swagger-ui/index.html](http://ondetamoto-rm557462.azurewebsites.net/swagger-ui/index.html)

Para testar os endpoints, voc√™ precisar√° da URL do seu App Service (ex: `https://ondetamoto-rm557462.azurewebsites.net`). Voc√™ pode encontr√°-la na p√°gina de vis√£o geral do seu App Service no portal Azure.

> **Importante:**
> Crie um **Estabelecimento** antes de criar um **Setor** e crie um **Setor** antes de adicionar uma **Moto**. O ID gerado em um passo √© usado no pr√≥ximo.

#### Exemplo 1: `POST` (Registrar Usu√°rio)

```bash
{
    "email": "henriquechaco@gmail.com",
    "senha": "SenhaForte123",
    "role": "ADMIN"
}
```

#### Exemplo 2: `POST` (Criar Estabelecimento)

```bash
{
    "endereco": "Avenida Lins de Vasconcelos 362"
}
```

#### Exemplo 3: `POST` (Criar Setor)

```bash
{
    "nome": "Ala de Reparos R√°pidos",
    "tipo": "MANUTENCAO",
    "tamanho": "Grande",
    "idEstabelecimento": 1
}
```

#### Exemplo 4: `POST` (Adicionar Moto)


```bash
{
    "marca": "Honda",
    "placa": "XYZ1234",
    "tag": "MT-01",
    "idSetores": 1
}
```

---

## üí° Considera√ß√µes Finais e Troubleshooting

* **Flyway**: Verifique se os seus scripts de migra√ß√£o do Flyway (`V1__create_table.sql`, etc.) est√£o corretos na pasta `src/main/resources/db/migration` do seu projeto. Erros aqui s√£o uma causa comum de falha na inicializa√ß√£o da aplica√ß√£o.
* **Depend√™ncias**: Confirme se o seu arquivo `build.gradle` ou `pom.xml` cont√©m todas as depend√™ncias necess√°rias (Spring Web, Spring Data JPA, SQL Server Driver, Flyway, etc.).
* **Logs**: Se a aplica√ß√£o falhar ao iniciar, verifique os logs. V√° para o App Service no Portal Azure > **Ferramentas de Desenvolvimento** > **Fluxo de Log** para ver os logs em tempo real.

---

## üßë‚Äçüíª Integrantes do Grupo

- **Guilherme Romanholi Santos - RM557462**
- **Murilo Capristo - RM556794**
- **Nicolas Guinante Cavalcanti - RM557844**
